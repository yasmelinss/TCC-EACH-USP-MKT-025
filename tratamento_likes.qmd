---
title: "Tratamento de dados de Likes"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    embed-resources: true
execute: 
  cache: true
---

```{r}
#| label: setup

library(dplyr)
library(purrr)
library(Hmisc)
library(tidyverse)
library(grDevices)
```


```{r}
#| label: data-frame-likes

caminho_pasta <-
  "Dados/likes"

df_likes <- 
  list.files(
    path = caminho_pasta, 
    pattern = "\\.rds$", 
    full.names = TRUE
    ) |>
  
  map(readRDS) |>
    list_rbind()

head(df_likes)
```


```{r}
#| label: períodos
 
inicio.bloqueio <- "30-08-2024" |> dmy()
(inicio.busca <- inicio.bloqueio - 4 * dweeks())

final.bloqueio <- "08-10-2024" |> dmy()
(final.busca <- final.bloqueio + 2 * ddays() + 4 * dweeks())

```


```{r}
#| label: likes-por-dia

likes_por_dia <- 
  df_likes |>
  
  mutate(
    dia = dmy(
      format(
        created_at, 
        "%d/%m/%Y"
        )
      )
    ) |>
  filter(dia >= inicio.busca, dia <= final.busca) |>
  count(dia, name = "frequencia")

head(likes_por_dia)
```

```{r}
# criando estrutura do mapa ----

ggplot(
  likes_por_dia,
    aes(
      x = dia, 
      y = 1, 
      fill = frequencia
      )
    ) +
  
  geom_tile() +
    ggplot2::scale_fill_viridis_c(
    option = "inferno",
    trans = "log10"
  ) +
  
  labs(
    title = "Mapa de calor: Likes por dia",
    x = "Dia",
    y = NULL
  ) +
  
  theme_minimal() +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(
      angle = 45,
      hjust = 1
    )
  ) +

  ggplot2::geom_vline(
    xintercept = base::as.POSIXct(c(inicio.bloqueio, final.bloqueio)),
    color = "red",
    linewidth = 0.9,
    linetype = "dashed"
  ) +
  
  ggplot2::scale_x_date(
    date_labels = "%d/%m/%Y",
    date_breaks = "7 days"
  )

```

```{r}

ggplot(
  likes_por_dia,
  aes(
    x = dia,
    y = frequencia,
    fill = frequencia
  )
) +
  geom_col() +
  scale_fill_viridis_c(
    option = "inferno", 
    direction = 1,
    trans = "log10"
    ) +
  labs(
    title = "Frequência de likes por dia",
    fill = "Likes"
  ) +
  ggplot2::geom_vline(
    xintercept = base::as.POSIXct(c(inicio.bloqueio, final.bloqueio)),
    color = "red",
    linewidth = 0.9,
    linetype = "dashed"
  ) +
  theme_bw()

#zoom para ver melhor os de valor baixo
# + 
#  coord_cartesian(
#    ylim = c(
#      0, 
#      5000
#    )
#  )
  
```







# 


```{r}
#| label: juntando-uri

# não fuunciona
likes_df_2 <- 
  map_df(caminho_pasta, function(arq) {

    df <- read_rds(arq)

    nome <- basename(arq) |> str_remove("*.rds")

    uri_post <- nome |>
      str_replace("^", "at://did:plc:") |>
      str_replace("-", "/app.bsky.feed.post/")

    df |> mutate(uri.post = uri_post)
  })

```

```{r}
#| label: fazendo-join

likes_join <- 
  left_join(likes_df, skeets.curto, by = c("uri.post" = "uri.post"))
```



```{r}

likes_stats <- likes_por_dia |>
  summarise(
    media = mean(frequencia),
    mediana = median(frequencia),
    minimo = min(frequencia),
    maximo = max(frequencia),
    desvio_padrao = sd(frequencia),
    total_likes = sum(frequencia),
    dias = n()
  )

likes_stats

```

