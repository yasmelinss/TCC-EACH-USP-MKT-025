---
title: "Metricas de rede"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    embed-resources: true
execute: 
  cache: true
---

```{r}
#| label: setup
#| warning: false

library(tidyverse)
`%!in%` <- negate(`%in%`)
options(scipen = 99)
library(tidygraph)
library(ggraph)
library(igraph)


```

## Carregando dados

```{r}
#| label: carrega-likes

# likes
likes <- read_rds("Dados/likes.rds")
liker.actors <- read_rds("Dados/liker-actors.rds")
liked.actors <- read_rds("Dados/liked-actors.rds")
likes.actors <- read_rds("Dados/likes-actors.rds")
all.actors.likes <- read_rds("Dados/all-actors-likes.rds")
matriz.likes <- read_rds("Dados/matriz-likes.rds")
```

## Verificando a matriz de likes para todos os dias

fazendo períodos

```{r}
#| label: períodos
 
inicio.bloqueio <- "30-08-2024" |> dmy()
(inicio.busca <- inicio.bloqueio - 4 * dweeks())

final.bloqueio <- "08-10-2024" |> dmy()
(final.busca <- final.bloqueio + 2 * ddays() + 4 * dweeks())

dias.periodo <- seq.Date(from = inicio.busca, to = final.busca, by = "day")
```
fazendo uma matriz para cada dia

```{r}
#| label: matriz-cada-dia

matriz.likes <- readRDS("Dados/matriz-likes.rds")

matriz.lista.dias <- 
  map(
    dias.periodo,
    ~matriz.likes |>
        filter(date(data.skeet) == .x) |> 
        count(
          actor.influenced.num, 
          actor.influencer.num, 
          name = "quantos"
        )
  )
  
names(matriz.lista.dias) <- dias.periodo |> format("%Y-%m-%d")

```

salvando

```{r}

walk(
  names(matriz.lista.dias),
  ~ write_rds(
      matriz.lista.dias[[.x]],
      paste0("Dados/matrizes-dia/", .x, "-likes.rds")
    )
)

```

criando um vetor das matrizes

```{r}

vetor.matrizes.dias.likes <- 
  list.files(
    path = "Dados/matrizes-dia",
    pattern = "\\.rds$",
    full.names = TRUE
  )

```

não precisa rodar

quantidade de matrizes (98 dias)

```{r}

n_arquivos <- length(list.files("Dados/matrizes-dia"))
n_arquivos

```

Modificando/Limpando all.actors.likes

```{r}
#| label: limpando-handles

all.actors.likes <-
  all.actors.likes |>
    mutate(
      handle = case_when(
        did == "did:plc:uk7niqvqdgr74qhwb4vrg3vi" ~ "LTA_SUL",
        TRUE ~ handle
      )
    ) |>
    
    group_by(did) |> 
    filter(n() == 1 | n() > 1 & !is.na(handle)) |> 
    ungroup() |> 
    mutate(
      handle = 
        if_else(
          is.na(handle), 
          "handle.missing", 
          handle
        )
    ) |> 
    group_by(handle) |> # só missing e invalid é que sejam juntados 
    mutate(
      handle =
        if_else(
          n() == 1 + 0 * nchar(handle),
          handle |> 
            str_remove(fixed(".bsky.social")),
          handle |> 
            str_c(".", seq(n()))
        )
    )
```


Vendo como está para um dia específico e tirando medidas de centralidade em função dos likes

Da matriz 1 a 27 - não há likes (ninguém curtiu ou foi curtido)

A partir do dia 28 - há likes

exemplo do dia [37] = 07-09-2024



```{r}
dia37 <- readRDS(vetor.matrizes.dias.likes[[37]])

# in-degree: quem RECEBE likes (actor.influenced.num)
in_dia37 <- 
  dia37 |>
  group_by(actor.influenced.num) |>
  summarise(
    in_degree = sum(quantos),
    .groups = "drop"
  ) |>
  rename(actor.num = actor.influenced.num)

# out-degree: quem DÁ likes (actor.influencer.num)
out_dia37 <- 
  dia37 |>
  group_by(actor.influencer.num) |>
  summarise(
    out_degree = sum(quantos),
    .groups = "drop"
  ) |>
  rename(actor.num = actor.influencer.num)

# junta in + out por ator
metricas_agregadas_dia37 <- 
  full_join(in_dia37, out_dia37, by = "actor.num") |>
  replace_na(list(in_degree = 0, out_degree = 0)) |>
  mutate(
    saldo  = in_degree - out_degree,
    spread = in_degree + out_degree - abs(saldo)
  ) |>
  left_join(
    all.actors.likes |> select(num, did, handle),
    by = c("actor.num" = "num")
  ) |>
  relocate(did, handle, .after = actor.num) |>
  arrange(desc(in_degree))

saveRDS(metricas_agregadas_dia37, "Dados/metricas_agregadas_dia37.rds")
```

```{r}
#TODOS OS DIAS

# matriz.lista.dias já tem names com datas no formato "YYYY-MM-DD"

metricas_todos_dias <- 
  imap_dfr(
    matriz.lista.dias,
    ~ {
      dia <- .x      # data.frame desse dia
      data_str <- .y # nome da lista, ex: "2024-09-07"
      
      # in-degree: quem recebe likes
      in_dia <- 
        dia |>
        group_by(actor.influenced.num) |>
        summarise(
          in_degree = sum(quantos),
          .groups = "drop"
        ) |>
        rename(actor.num = actor.influenced.num)
      
      # out-degree: quem dá likes
      out_dia <- 
        dia |>
        group_by(actor.influencer.num) |>
        summarise(
          out_degree = sum(quantos),
          .groups = "drop"
        ) |>
        rename(actor.num = actor.influencer.num)
      
      # junta in + out para o dia
      full_join(in_dia, out_dia, by = "actor.num") |>
        replace_na(list(in_degree = 0, out_degree = 0)) |>
        mutate(
          saldo  = in_degree - out_degree,
          spread = in_degree + out_degree - abs(saldo),
          data   = ymd(data_str)
        ) |>
        left_join(
          all.actors.likes |> select(num, did, handle),
          by = c("actor.num" = "num")
        ) |>
        relocate(data, actor.num, did, handle)
    }
  )

saveRDS(metricas_todos_dias, "Dados/metricas-todos-dias" )
```
