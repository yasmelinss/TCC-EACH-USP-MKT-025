---
title: "Terceiro Teste de Raspagem no Bluesky"
author: "Yasmin Messias Lins"
lang: pt-br
format: html
# format: 
#   pdf:
#     geometry:
#       - top=1in
#       - bottom=1in
#       - left=1in
#       - right=1in
#       - heightrounded
execute: 
  cache: false
---

# SETUP
```{r}
#| label: setup
#| warning: false

#library(bskyr)
library(tidyverse)
library(readr)
library(jsonlite)
library(atrrr)
library(ggplot2)
library(igraph)

# funções úteis
quebra <- function(string, tamanho = 80) {
  str_split(string, "\n", simplify = TRUE) |> 
    c() |> 
    sapply(
      \(x)
      sapply(
        1:(nchar(x) %/% tamanho + 1), 
        \(k) str_sub(x, start = (k - 1) * tamanho + 1, end = k * tamanho),
        simplify = TRUE,
        USE.NAMES = FALSE
      ),
      simplify = TRUE,
      USE.NAMES = FALSE
    ) |> 
    unlist() |> 
    paste(collapse = "\n") |> 
    cat()
  
}
formataJSON <- function(string) {
  toJSON(string, pretty = TRUE) |> 
    quebra()
}
```

# Autenticação

```{r}
#| label: autenticando

#autenticação


auth(
  user = 'yasmelinss.bsky.social',
  password = read_lines("senha.txt"),
  overwrite = TRUE
)
```


# CONVERSÃO

<-- Entendendo o padrão de URL do Bluesky -->

- DID: Identificador descentralizado

```{r}
#| label: url-to-uri

"at://did:plc:g4efut5lyfkz6wxoejsuo2dw/app.bsky.feed.post/3m5na7ychbk\n25" |>
convert_http_to_at(.token = NULL)
```


```{r}
#| label: uri-to-url

"at://did:plc:g4efut5lyfkz6wxoejsuo2dw/app.bsky.feed.post/3m2iaytbuxk2q" |>
  convert_at_to_http()
```


# MINERAÇÃO / EXTRAÇÃO DE DADOS

## Buscando por URIs

### Busca por termos

Procurando post com query específica



```{r}
#| label: extracao-search-post

pesquisa <-
  search_post(
    q = 'cblol -nsfw',
    limit = 100L
  )
    
#formataJSON(pesquisa)
```

```{r}
#| label: filtragem-search-post

pesquisa |>
  select(
    uri,
    author_handle,
    text
  )
```

```{r}
#| label: extracao-search-skeet

#skeet <-
#  search_skeet(
#    q = 'League of Legends',
#    limit = 10L
#  )

#formataJSON(skeet)


```

```{r}
#| label: filtragem-search-skeet

#skeet |>
#  select(
#   uri,
#    author_handle,
#    text
#  )
```



### Busca por usuário


Buscando perfis com uma query específica

```{r}
#| label: buscando-perfis-search

buscando_perfis <- 
  search_user(
    query = 'league of legends',
    limit = 2
  )

formataJSON(buscando_perfis)

```



```{r}
#| label: filtragem-buscando-perfis-search

buscando_perfis |>
  select(
    did,
    handle,
    display_name,
    associated_activity_subscription,
    description
  )

```





## Extraindo por URIs


A função `get_skeets_authored_by()` retorna um dataframe com as seguintes variáveis:

- `uri`: Padrão de redirecionamento do *Bluesky*, funciona como o "endereço" do post.
- `cid`: *Content Identifier* - um hash que representa o conteúdo do post de forma única
- `author_handle`: *"@"* do perfil ou nome público de uma conta
- `author_name`: Nome não oficial da conta exibido
- `text`: Conteúdo em texto do post, pode conter texto, menções, emojis e links
- `author_data`: Informações do perfil
  - `did`, 
  - `handle`, 
  - `bio`, 
  - link da imagem de perfil 
- `post_data`: Informações sobre o post como a data de criação e dados *embed* como anexos, citações e imagens
- `embed_data`: Informações sobre o conteúdo incorporado (embed), como outro post citado, imagem ou link
- `reply_count`: quantidade de respostas ou comentários
- `repost_count`: quantidade de *reposts* ou compartilhamentos ou *reskeet*
- `like_count`: quantidade de *likes* ou curtidas
- `quote_count`: quantidade de *reposts* com marcação ou citação *
- `indexed_at`: data da publicação no servidor do *Bluesky*
- `in_reply_to`: URI do post ao qual este responde (caso seja uma resposta direta).
- `in_reply_root`: URI do post original na cadeia de respostas (a “raiz” da conversa).
- `quotes`: URIs de posts que foram citados por este post
- `tags`: Lista de hashtags incluídas no post
- `mentions`: Lista de usuários mencionados
- `links`: Links externos incluídos no texto do post
- `langs`: Idiomas detectados no texto
- `labels`: Rótulos automáticos atribuídos
- `is_reskeet`: (booleano) verifica se é um *repost*

### Mineração Post/usuário

```{r}
#| label: extracao-user-posts

dplyr::glimpse(
  "yasmelinss.bsky.social" |> 
    get_skeets_authored_by(
      parse = TRUE
    )
  )
```


com a função (`get_thread`) buscamos informações que vão além do post, também compilamos informações sobre suas interações.

O primeiro resultado da postagem trás informações do *reskeet* 
raiz. Os próximos trazem dados das interações.


```{r}
#| label: extracao-thread

tabble <- 'https://bsky.app/profile/yasmelinss.bsky.social/post/3m2iaytbuxk2q'|>
  get_thread()

formataJSON(tabble)
```



```{r}
#| label: extracao-thread-jeito-2

buscando_thread_dois <-
  get_thread(
    post_url = 'https://bsky.app/profile/pupn1k.bsky.social/post/3m2kh4cgtk22q',
    .token = NULL
  )

formataJSON(buscando_thread_dois)
``` 


filtrando dados


```{r}
#| label: extracao-thread-pre

dados <-
'https://bsky.app/profile/pupn1k.bsky.social/post/3m2kh4cgtk22q'|>
  get_thread()

```


```{r}
#| label: filtragem-extracao-thread
#| eval: true

#ele não está pegando TODOS os dados
dados |>
  transmute(
    nome = author_name, 
    handle = author_handle,
    nome_publico = author_data$displayName,
    texto = text, 
    n_likes = like_count, 
    n_replies = reply_count
  ) |>
  view()
```


### Mineração Likes

Raspagem dos perfis que curtiram determinado post.

Metadados trazidos pela (`get_likes`)

- `created_at`:
- `indexed_at`:
- `actor_handle`:
- `actor_name`:
- `actor_data`:
- `did`:
- `handle`:
- `avatar`:
- `associated`:
- `viewer`: informação se está mutado, bloqueado ou seguindo. trás a uri de `following` com `followedBy` (o nome do usuário aparece quando convertemos a URI para URL)
- `labels`:
- `createdAt`:
- `description`: 
- `indexedAt`:


```{r}
#| label: extracao-users-likes


likes <-
  get_likes(
    post_url = 'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x',
    cursor = NULL,
    parse = TRUE,
    verbose = NULL,
    .token = NULL
  )
formataJSON(likes)
```


```{r}
#| label: extracao-users-likes-1

'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x' |> 
  get_likes(
    limit = 2L,
  )
```

```{r}
#| label: extracao-users-likes-2

likess <-
  'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x' |>
    get_likes(
      limit = 2L
    )
```

```{r}
#| label: filtragem-users-likes

likes |>
  select(
    actor_handle,
    actor_name
  ) |>
  head()
```




### Mineração Reposts


- `did`:
- `actor_handle`:
- `actor_name`:
- `actor_avatar`:
- `associated`: grupa configurações opcionais ligadas ao comportamento social do usuário, ou seja, quem pode mandar mensagens e quem pode acompanhar atividades (como notificações de posts, likes, etc.).
- `viewer`:
- `labels`:
- `created_at`:
- `actor_description`:
- `indexed_at`:

| Caso | Chat permitido para | Assinaturas permitidas para | Indica                           |
| ---- | ------------------- | --------------------------- | -------------------------------- |
| 1⃣  | Seguindo            | Seguidores                  | Privado / restrito               |
| 2⃣  | (ausente)           | Seguidores                  | Chat desativado ou não retornado |
| 3⃣  | Todos               | Seguidores                  | Mais aberto / público            |



```{r}
#| label: extracao-users-repost


repost <-
  get_reposts(
    post_url = 'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x',
    limit = 2L,
    cursor = NULL,
    parse = TRUE,
    verbose = NULL,
    .token = NULL
  )

formataJSON(repost)
```

```{r}
#| label: extracao-users-repost-2

reposts <-
  'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x' |>
  get_reposts()
```


```{r}
#| label: filtragem-users-repost

#também está limitando os dados
reposts |>
    select(
      did,
      actor_name,
      actor_handle,
      associated

  ) |>
head()
```



### Mineração Quotes

### Mineração Seguindo/Seguidores

```{r}
#| label: extracao-followers


seguidores <-
  get_followers(
    actor = 'yasmelinss.bsky.social',
    limit = 25L
  )

formataJSON(seguidores)
```

```{r}
#| label: extracao-follows


seguindo <-
  get_follows(
    'yasmelinss.bsky.social',
    limit = 25L
  )

formataJSON(seguindo)
```




# CONEXÃO


##Seguidores em comum


Queremos um grafo em que:

nós (nodes) são contas do Bluesky (handles ou DIDs),

arestas (edges) ligam contas que se seguem em comum (por exemplo, ambas seguem pastelveve.bsky.social, ou ambas são seguidas por ela).

```{r}
#| label: teste-raquel

seguidores <-
  get_followers(
    actor = 'pastelveve.bsky.social',
    limit = 1L
  )

dado1 <-
  seguidores |> 
    select(
      actor_handle
    )

convert_at_to_http(seguidores)


dado1 |>
  get_followers()

formataJSON(dado1)



```

```{r}

contas_iniciais <- c(
  "pastelveve.bsky.social",
  "yasmelins.bsky.social",
  "ennoe.bsky.social"
)

# 2. Função auxiliar para buscar seguidores
pegar_seguidores <- function(handle) {
  get_followers(actor = handle, limit = 50L) |> 
    select(actor_handle) |> 
    mutate(origem = handle)
}

# 3. Buscar seguidores de todas as contas
todos_seguidores <- map_df(contas_iniciais, pegar_seguidores)

# 4. Ver dados brutos
head(todos_seguidores)

# 5. Encontrar quem segue mais de uma dessas contas
seguidores_comuns <- todos_seguidores |>
  group_by(actor_handle) |>
  summarise(segue_quantas = n_distinct(origem),
            contas_seguidas = paste(origem, collapse = ", ")) |>
  filter(segue_quantas > 1)

# 6. Criar grafo (arestas entre contas seguidas em comum)
arestas <- todos_seguidores |>
  semi_join(seguidores_comuns, by = "actor_handle") |>
  select(actor_handle, origem) |>
  rename(from = actor_handle, to = origem)

grafo <- graph_from_data_frame(arestas, directed = TRUE)

# 7. Visualizar grafo simples
plot(
  grafo,
  vertex.size = 5,
  vertex.label.cex = 0.6,
  main = "Grafo de seguidores em comum"
)


```

