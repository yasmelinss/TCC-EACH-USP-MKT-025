---
title: "Terceiro Teste de Raspagem no Bluesky"
author: "Yasmin Messias Lins"
lang: pt-br
format: html
# format: 
#   pdf:
#     geometry:
#       - top=1in
#       - bottom=1in
#       - left=1in
#       - right=1in
#       - heightrounded
execute: 
  cache: false
---

# SETUP
```{r}
#| label: setup

#library(bskyr)
library(tidyverse)
library(readr)
library(jsonlite)
library(atrrr)
```


# AUTENTICAÇÃO

# CONVERSÃO

<-- Entendendo o padrão de URL do Bluesky -->

- DID: Identificador descentralizado

```{r}
#| label: url-to-uri

"https://bsky.app/profile/yasmelinss.bsky.social/post/3m2iaytbuxk2q" |>
convert_http_to_at(.token = NULL)
```


```{r}
#| label: uri-to-url

"at://did:plc:4bvoxokewgsqfjfefnzsppny/app.bsky.graph.follow/3m2idq3n4b22n" |>
  convert_at_to_http()
```


# RASPAGEM

## Searching / Aleatória

### Busca por posts

Procurando post com query específica

```{r}
#| label: buscando-posts-search

buscando_posts <- 
  bs_search_posts(
    query = '"league of legends" since:2024-08-30 until:2024-10-08',
    limit = 1,
    auth = auth
  )

formataJSON(buscando_posts)
```


```{r}
#| label: filtragem-buscando-posts-search

buscando_posts |>
    select(
      uri,
      author,
      #text,
      reply_count,
      repost_count,
      like_count,
      indexed_at
      
      
  ) |>
head()
```


### Busca por usuário


Buscando perfis com uma query específica

```{r}
#| label: buscando-perfis-search
#| eval: true

buscando_perfis <- 
  bs_search_actors(
    'league of legend',
    typeahead = FALSE, 
      # se typeahead == TRUE, então faz uma busca tipo "sugestão enquanto digita"
    cursor = NULL,
    limit = 2,
    auth = auth,
    clean = FALSE
)

formataJSON(buscando_perfis)
```



```{r}
#| label: filtragem-buscando-perfis-search

buscando_posts |>
    select(
      #actors
  ) |>
head()

```





## Específicada

### Raspagem post/usuário

A função (`get_skeets_authored_by`) fornece os seguintes metadados:

- `$ uri`: Padrão de redirecionamento do *Bluesky*, funciona como o "endereço" do post.
- `$ cid`: *Content Identifier* - um hash que representa o conteúdo do post de forma única
- `$ author_handle`: *"@"* do perfil ou nome público de uma conta
- `$ author_name`: Nome não oficial da conta exibido
- `$ text`: Conteúdo em texto do post, pode conter texto, menções, emojis e links
- `$ author_data`: Informações do perfil
-- *did*, *handle*, *bio*, link da imagem de perfil 
- `$ post_data`: Informações sobre o post como a data de criação e dados *embed* como anexos, citações e imagens
- `$ embed_data`: Informações sobre o conteúdo incorporado (embed), como outro post citado, imagem ou link
- `$ reply_count`: quantidade de respostas ou comentários
- `$ repost_count`: quantidade de *reposts* ou compartilhamentos ou *reskeet*
- `$ like_count`: quantidade de *likes* ou curtidas
- `$ quote_count`: quantidade de *reposts* com marcação ou citação *
- `$ indexed_at`: data da publicação no servidor do *Bluesky*
- `$ in_reply_to`: URI do post ao qual este responde (caso seja uma resposta direta).
- `$ in_reply_root`: URI do post original na cadeia de respostas (a “raiz” da conversa).
- `$ quotes`: URIs de posts que foram citados por este post
- `$ tags`: Lista de hashtags incluídas no post
- `$ mentions`: Lista de usuários mencionados
- `$ links`: Links externos incluídos no texto do post
- `$ langs`: Idiomas detectados no texto
- `$ labels`: Rótulos automáticos atribuídos
- `$ is_reskeet`: (booleano) verifica se é um *repost*


```{r}
#| label: raspagem-user-posts

dplyr::glimpse(
  "yasmelinss.bsky.social" |> 
    get_skeets_authored_by(
      parse = TRUE
    )
  )
```


aqui buscamos informações que vão além do post, também compilamos informações sobre suas interações.

O primeiro resultado da postagem trás informações do *reskeet* 
raiz. Os próximos trazem dados das interações.


```{r}
#| label: raspagem-thread

'https://bsky.app/profile/pupn1k.bsky.social/post/3m2kh4cgtk22q'|>
  get_thread()

```



```{r}
#| label: raspagem-thread-jeito-2

toJSON(get_thread(
post_url = 'https://bsky.app/profile/pupn1k.bsky.social/post/3m2kh4cgtk22q',
.token = NULL
), pretty = TRUE)
``` 


filtrando dados


```{r}
#| label: filtragem-thread-pré

dados <-
'https://bsky.app/profile/pupn1k.bsky.social/post/3m2kh4cgtk22q'|>
  get_thread()

```


```{r}
#| label: filtragem-thread
#| eval: true

#ele não está pegando TODOS os dados
dados |>
    select(
      author_name, 
      author_handle, 
      text, 
      like_count, 
      reply_count
  ) |>
head()

```


### Raspagem likes

Raspagem dos perfis que curtiram determinado post.

Metadados trazidos pela (`get_likes`)
- `$ created_at`:
- `$ indexed_at`:
- `$ actor_handle`:
- `$ actor_name`:
- `$ actor_data`:
-- `$ did`:
-- `$ handle`:
-- `$ avatar`:
-- `$ associated`:
-- `$ viewer`: informação se está mutado, bloqueado ou seguindo. trás a uri de `$ following` com `$ followedBy` (o nome do usuário aparece quando convertemos a URI para URL)
- `$ labels`:
- `$ createdAt`:
- `$ description`: 
- `$ indexedAt`:


```{r}
#| label: raspagem-users-likes


toJSON(get_likes(
post_url = 'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x',
limit = 2L,
cursor = NULL,
parse = TRUE,
verbose = NULL,
.token = NULL
), pretty = TRUE)
```

```{r}
#| label: raspagem-users-likes-2

likes <-
  'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x' |>
    get_likes()

```

```{r}
#| label: filtragem-users-likes

likes |>
  select(
    actor_handle,
    actor_name
  ) |>
  head()

```




### Raspagem reposts


- `$ did`:
- `$ actor_handle`:
- `$ actor_name`:
- `$ actor_avatar`:
- `$ associated`: grupa configurações opcionais ligadas ao comportamento social do usuário, ou seja, quem pode mandar mensagens e quem pode acompanhar atividades (como notificações de posts, likes, etc.).
- `$ viewer`:
- `$ labels`:
- `$ created_at`:
- `$ actor_description`:
- `$ indexed_at`:

| Caso | Chat permitido para | Assinaturas permitidas para | Indica                           |
| ---- | ------------------- | --------------------------- | -------------------------------- |
| 1⃣  | Seguindo            | Seguidores                  | Privado / restrito               |
| 2⃣  | (ausente)           | Seguidores                  | Chat desativado ou não retornado |
| 3⃣  | Todos               | Seguidores                  | Mais aberto / público            |



```{r}
#| label: raspagem-users-repost


toJSON(get_reposts(
post_url = 'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x',
limit = 2L,
cursor = NULL,
parse = TRUE,
verbose = NULL,
.token = NULL
), pretty = TRUE)
```

```{r}
#| label: raspagem-users-repost-2

reposts <-
  'https://bsky.app/profile/prokopetz.bsky.social/post/3m2wq3l3au22x' |>
  get_reposts()

```


```{r}
#| label: filtragem-users-repost

#também está limitando os dados
reposts |>
    select(
      did,
      actor_name,
      actor_handle,
      associated

  ) |>
head()

```


