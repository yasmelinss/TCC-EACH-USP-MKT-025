---
title: "Primeiro Teste de Raspagem no Bluesky"
author: "Thales de Fante Rom√£o"
lang: pt-br
format: html
---

```{r}
#| label: setup
#| eval: true
#| warning: false

library(bskyr)
library(tidyverse)
library(readr)
library(jsonlite)
```

## dados da autentica√ß√£o do usu√°rio para a raspagem

Usando o login do Thales

```{r}
#| label: usuario-autentica√ß√£o
actor <- 'ennoe.bsky.social'

auth <- 
  bs_auth(
    user = "ennoe.bsky.social", 
    pass = "omp6-axyy-kme6-i4gm"
  )
```

[Explica√ß√£o do Bluesky sobre os app passwords](https://blueskyfeeds.com/faq-app-password)

## raspando p√°ginas √† procura da string `"league of legends"`

Raspagem de teste
- busca por post com uma palavra chave

```{r}
#| label: testando-search-posts

posts <- 
  bs_search_posts(
    query = '"league of legends" since:2024-08-30 until:2024-10-08',
    limit = 10,
    auth = auth
  ) 

posts |> 
  toJSON(pretty = TRUE)
```




texto da documenta√ß√£o da biblioteca `{blskyr}` que deixei aqui para encontrar mais f√°cil `r 2+2`

```
Arguments
query Character vector, length 1. character. Search query, Lucene query syntax is
recommended.
sort character. Order or results. Either 'top' or 'latest'
since character. Filter results for posts on or after the indicated datetime or ISO date
(YYYY-MM-DD).
until character. Filter results for posts before the indicated datetime or ISO date
(YYYY-MM-DD).
mentions character. Filter to posts which mention the given account.
author character. Filter to posts by the given account.
lang character. Filter to posts in the given language.
domain character. Filter to posts with URLs (facet links or embeds) linking to the given
domain (hostname). Server may apply hostname normalization.
url character. Filter to posts with links (facet links or embeds) pointing to this URL.
Server may apply URL normalization or fuzzy matching.
tag character. Filter to posts with the given tag (hashtag), based on rich-text facet or
tag field. Do not include the hash (#) prefix. Multiple tags can be specified, with
‚ÄôAND‚Äô matching.
cursor Character, length 1. A cursor property from a prior response. Default: NULL.
limit Integer. Number of records to request. If over 100, multiple requests are made.
user Character. User name to log in with. Defaults to get_bluesky_user().
pass Character. App password to log in with. Defaults to get_bluesky_pass().
auth Authentication information. Defaults to bs_auth(user, pass).
clean Logical. Should output be cleaned into a tibble? Default: TRUE.

```

RESULTADO

[P√°gina de documenta√ß√£o do bluesky](https://bsky.social/about/blog/05-31-2024-search)
com mais campos (keywords) que podem ser usadas nas queries


descobrindo as informa√ß√µes que a raspagem traz

N√£o sei de a formata√ß√£o est√° correta


- `$uri` - c√≥digo do post
- `$cid`` - c√≥digo do post
- $author - c√≥digo do post
- $handle - nome do *user*
- $displayName - nome escolhido pelo usu√°rio
- $avatar - foto de perfil
- `$associated` > `$chat` > `$allowIncoming` (chr "followers")
- $activitySubscription > > $allowSubscriptions (chr "followers")
- $muted - mutado (false)
- $blockedBy - bloqueado (false)
- $createdAt - data de cria√ß√£o do usu√°rio
- $type - app.bsky.feed.post
- $createdAt - data de cria√ß√£o do post
- $embed > $type > $external> $description - conte√∫do do post
- $title - primeiras linhas do post se ele tiver um t√≠tulo
- $uri - um link colocado pelo usu√°rio
- $type: chr "app.bsky.richtext.facet#tag" -  inicia a busca por #
- $tag - a # usada. ele tamb√©m puxa os bytes da #
- $type: chr "app.bsky.richtext.facet#link" - inicia a busca pelo link colocado
- $text - conte√∫do do post em si
- > $embed > $ > $type   : chr "app.bsky.embed.external#view"> external > -  RESUMO DO POST com $uri, $title, $description, $thumb - display do link
- $reply_count - quantidade de coment√°rios
- $reposts_count - quantidade de compartilhamento "repost"
- $like_count - quantidade de curtidas
- $quote_count - deve ser quantidade de men√ß√µes
- $indexed_at - data do post


```{r}
#| label: exportando-xlsx
#| eval: false

#Salvar um data frame chamado posts em um arquivo Excel chamado teste_raspagem_urls.xlsx, usando a fun√ß√£o write_xlsx().
write_xlsx(posts, path = "teste_raspagem_urls.xlsx")
```


```{r}

#| label: transformando-em-URLs
#| eval: false
#acessa a coluna uri do dataframe posts
uris <- posts$uri  
print(uris)

convert_uri_to_url <- function(uri) {
   # Remove 'at://'
   clean <- sub("^at://", "", uri)
   # Divide em partes pelo √∫ltimo '/'
   parts <- strsplit(clean, "/")[[1]]
   did <- parts[1]
   post_id <- parts[length(parts)]
   paste0("https://bsky.app/profile/", did, "/post/", post_id)
 }

# Exemplo:
uris <- c("at://did:plc:kwssn4xujlrl4ybhzm5vt5mg/app.bsky.feed.post/3l5xjaj66js24")
urls <- sapply(uris, convert_uri_to_url)
print(urls)

```

```{r}

#| label: testando-convert-uri-to-url-sem-gpt
#| eval: true

bs_uri_to_url(
  'at://did:plc:ic6zqvuw5ulmfpjiwnhsr2ns/app.bsky.feed.post/3k7qmjev5lr2s'

  )
  

bs_url_to_uri(
  'https://bsky.app/profile/ennoe.bsky.social',
    auth = auth
  )



```


```{r}
#| label: exemplo-sub-dataframe
#| eval: false
posts |>
  select(uri, cid, author) |> 
  filter(author == "z√© das couves") |> 
  summarize()
```

```{r}
#| label: testando-follows-suggestions
#| eval: true

follows_suggestions <- 
  bs_get_follow_suggestions(
    actor,
    user = user,
    pass = pass,
    auth = auth,
    
  )

print(follows_suggestions)

```

```{r}
#| label: testando-get-followers
#| eval: true

# retorna os perfis que seguem um determinado ator (usu√°rio)

seguidores <-
  bs_get_followers(
    actor,
    cursor = NULL,
    limit = 10,
    auth = auth,
    clean = FALSE
  )    

print(seguidores)
```
Creio que funciona e as mesmas inforema√ß√µes padr√µes

```{r}
#| label: testando-get-follows
#| eval: true

# retorna os perfis que seguem um determinado ator (usu√°rio)

seguindo <-
  bs_get_follows(
    actor,
    cursor = NULL,
    limit = 1,
    auth = auth,
    clean = FALSE
  )    

print(seguindo)
```


```{r}
#| label: testando-get-actor-lists
#| eval: false
  lista_ator <- 
    bs_get_actor_lists(
    actor = 'chriskenny.bsky.social',
    cursor = NULL,
    limit = NULL,
    user = user,
    pass = pass,
    auth = auth,
    clean = TRUE
  )

print(lista_ator)

```

```{r}
#| label: testando-create-record
#| eval: false

# Ela envia um novo registro (como um post, like, repost, etc.) para o servidor da Bluesky, dentro de uma cole√ß√£o espec√≠fica (como app.bsky.feed.post ou app.bsky.feed.like)

#bs_create_record(
  
#collection,
#record,
#user = user,
#pass = pass,
#auth = auth,
#clean = TRUE
#)
```

```{r}
#| label: testando-extract-record-key
#| eval: false
key <-
  bs_extract_record_key(
    'https://bsky.app/profile/chriskenny.bsky.social/post/3lc5d6zspys2c'
    )

print(key)
```

```{r}
#| label: testando-actor-lists
#| eval: true
# Retorna todas as listas p√∫blicas associadas a um determinado usu√°rio (ator) do Bluesky

puxarlista <- 
  bs_get_actor_lists(
  'ennoe.bsky.social',# Ex: 'usuario.bsky.social' ou 'did:plc:...'
  cursor = NULL,  # Para pagina√ß√£o de resultados
  limit = NULL,   # N√∫mero de listas a buscar (padr√£o: todas dispon√≠veis)
  auth = auth,  # Objeto de autentica√ß√£o
  clean = FALSE # Retorna um tibble limpo
)

print(puxarlista)
```

```{r}
#|label: testanto-actor-starter-packs
#|eval: true
# Starter packs s√£o listas p√∫blicas de contas sugeridas para seguir ‚Äî normalmente usadas para ajudar novos usu√°rios a encontrar contas interessantes, confi√°veis ou relevantes com base em temas (como ‚Äújornalismo‚Äù, ‚Äúarte‚Äù, ‚Äúci√™ncia‚Äù, etc.).

bs_get_actor_starter_packs(
  actor,       
  cursor = NULL, 
  limit = NULL,   
  auth = auth,
  clean = FALSE                 
)
```


```{r}
#|label: testando-get-actor-suggest
#|eval: true

# obter uma lista de perfis (atores) sugeridos para voc√™ seguir no Bluesky, com base nas recomenda√ß√µes do sistema da plataforma.

atorsugestao <-
  bs_get_actor_suggestions(
  cursor = NULL,
  limit = 10,    # Quantidade de sugest√µes (acima de 100 = m√∫ltiplas requisi√ß√µes)
  auth = auth,  # Objeto de autentica√ß√£o
  clean = FALSE
  )
print (atorsugestao)
```

O resultado desse chunk me intriga... Ele puxa campos como
- $did
- $handle: nome do usu√°rio
- $displayName: nome escolhido pelo usu√°rio
- $description: descri√ß√£o ou bio do usu√°rio
- $avatar: foto de perfil

```{r}
#| label: testando-feed-generator
#| eval: false

# Busca os posts de um feed personalizado, com base em um feed generator criado no Bluesky
#Para consumir feeds tem√°ticos curados por terceiros
#Para an√°lises sociais ou de conte√∫do
# construir dashboards com categorias de conte√∫do personalizadas

listafeedsdisponiveis <- 
  bs_get_feeds(
  actor, 
  cursor = NULL,
  limit = NULL,
  auth = auth,
  clean = FALSE
)

print(listafeedsdisponiveis)

retornapostmaisrecente <- 
  bs_get_feed(
  'https://bsky.app/profile/chriskenny.bsky.social/post/3lc5d6zspys2c',          # URI do feed generator
  cursor = NULL, #Para pagina√ß√£o (caso tenha muitos posts)
  limit = 1,  #N√∫mero m√°ximo de posts (padr√£o depende do servidor; se > 100, faz m√∫ltiplas chamadas)
  auth = auth,
  clean = FALSE
)

print(retornapostmaisrecente)
```
Acho que essa fun√ß√£o √© mais para a cria√ß√£o de BOTS

```{r}
#| label: testando-get-list
#| eval: true

# No Bluesky, listas s√£o cole√ß√µes personalizadas de perfis, criadas para agrupar e organizar pessoas que voc√™ segue ou outras contas.

gerandolista <-
  bs_get_list(
  list = 'at://did:plc:ragtjsm2j2vknwkz3zp4oxrd/app.bsky.graph.list/3kmokjyuflk2g',        
  cursor = NULL,  
  limit = 1,  
  auth = auth,
  clean = FALSE
)

print(gerandolista)
```
Quando usar?

- Para consultar e analisar o conte√∫do de listas espec√≠ficas no Bluesky
- Para mostrar a composi√ß√£o de uma lista em dashboards ou relat√≥rios
- Para gerenciar listas e seus membros via programa√ß√£o

```{r}
#| label: testando-get-likes
#| eval: false

# recupera postagens curtidas por um ator

pegarcurtidas <- 
  bs_get_likes(
  'ennoe.bsky.social',
  cursor = NULL,
  limit = 10,
  auth = auth,
  clean = FALSE
)

print(pegarcurtidas)
```


```{r}
#| label: testando-get-posts
#| eval: false

# busca um ou mais posts diretamente pela URL ou URI interna, e retorna seus conte√∫dos como uma tabela

bs_get_posts(
  'https://bsky.app/profile/chriskenny.bsky.social/post/3lc5d6zspys2c',
  auth = auth,
  clean = FALSE
  )
```


```{r}
#| label: testando-get-profile
#| eval: true

# obter as informa√ß√µes de perfil de um ou mais usu√°rios (atores) do Bluesky.

bs_get_profile(
  'ennoe.bsky.social',
  auth = auth,
  clean = FALSE
)
```


```{r}
#| label: testando-get-record 
```
üßæ O que √© um ‚Äúregistro‚Äù (record)?

Na arquitetura descentralizada do AT Protocol, tudo publicado √© um registro em um reposit√≥rio pessoal. Por exemplo:

Posts ‚Üí cole√ß√£o app.bsky.feed.post

Likes ‚Üí cole√ß√£o app.bsky.feed.like

Reposts ‚Üí cole√ß√£o app.bsky.feed.repost

Listas ‚Üí cole√ß√£o app.bsky.graph.list

Voc√™ precisa saber os 3 elementos: repo, collection, e rkey.

bs_get_record(
  repo = "bskyr.bsky.social",
  collection = "app.bsky.feed.post",
  rkey = "3kf2577exva2x"
)
Obs: Esse exemplo est√° "disfar√ßado" no formato de URL no manual:
https://bsky.app/profile/bskyr.bsky.social/post/3kf2577exva2x

A estrutura √©:
repo = bskyr.bsky.social
collection = app.bsky.feed.post
rkey = 3kf2577exva2x

Essa fun√ß√£o √© mais baixa n√≠vel que bs_get_posts() (que j√° lida com essas partes para voc√™).


A fun√ß√£o bs_get_relationships() da biblioteca blskyr permite verificar os relacionamentos entre um usu√°rio (ator) e outros usu√°rios no Bluesky, como:

- Quem segue quem
- Quem foi bloqueado
- Quem foi silenciado


```{r}
#| label: testando-get-relationships
#| eval: true

bs_get_relationships(
  actor = 'ennoe.bsky.social',
  others = c('bskyr.bsky.social', 'simko.bsky.social', 'yasmelins.bsky.social'),
  auth = auth,
  clean = FALSE
)|> 
toJSON(pretty = TRUE)
```

```{r}
#| label: nao-testando-get-repost
#| eval: false
# resposta um post
```

```{r}
#| label: nao-testando-get-timeline
#| eval: false
# retorna os posts mais recentes das contas que o usu√°rio segue, da mesma forma que aparecem no app do Bluesky.
```

```{r}
#| label: nao-testando-new-embed-external
#| eval: false
# cria um "preview" de um link externo (com t√≠tulo, descri√ß√£o e thumbnail), para ser inclu√≠do dentro de um post via bs_post().
```

```{r}
#| label: nao-testando-new-list
#| eval: false
# bs_new_list() cria uma lista personalizada que pode servir para moderar, curar conte√∫dos ou como refer√™ncia, com nome, prop√≥sito, descri√ß√£o e avatar.
#pode ser √∫til AINDA

```

```{r}
#| label: nao-testando-post
#| eval: false

# bs_post Make a post on Bluesky Social

#bs_post(
#text,
#images,
#images_alt,
#video,
#video_alt,
#langs,
#reply,
#quote,
#embed = TRUE,
#emoji = TRUE,
#max_tries,
#created_at = bs_created_at(),
#user = get_bluesky_user(),
#pass = get_bluesky_pass(),
#auth = bs_auth(user, pass),
#clean = TRUE
#)
```


```{r}
#| label: nao-testando-resolve-handle
#| eval: false

#bs_resolve_handle() pega um handle do Bluesky e retorna o DID correspondente, que √© um identificador √∫nico global usado para identificar contas de forma descentralizada.

```

```{r}
#| label: testando-search-actors
#| eval: true

# bs_search_actors() permite procurar perfis no Bluesky com base em uma consulta textual, retornando uma lista de contas que combinam com a busca. 

procurandoperfis <- 
  bs_search_actors(
    'league of legend', #query == texto da busca
    typeahead = FALSE, #se TRUE, faz uma busca tipo "sugest√£o enquanto digita" (autocomplete). Padr√£o: FALSE.
    cursor = NULL, #pagina√ß√£o a parti de uma resposta anterior
    limit = 2,
    auth = auth,
    clean = FALSE
)

print(procurandoperfis)

```

```{r}
#| label: nao-testando-has-bluesky-user
#| eval: false

#As fun√ß√µes has_bluesky_user() e get_bluesky_user() da biblioteca blskyr s√£o utilit√°rios para verificar e obter o nome de usu√°rio (handle) usado para se autenticar no Bluesky, geralmente de forma automatizada (como via vari√°vel de ambiente ou configura√ß√£o interna).

#Essas fun√ß√µes geralmente pegam o valor de uma vari√°vel de ambiente configurada previamente, como:
#Sys.setenv(BLUESKY_USER = "seunome.bsky.social") 
#Sys.setenv(BLUESKY_PASS = "seu_app_password")
#Depois disso, fun√ß√µes como get_bluesky_user() podem acessar automaticamente esses dados sem voc√™ precisar informar manualmente toda vez.
```

```{r}

#| label: testando-grafico


# Buscar dados
rel <-
bs_get_relationships (
  actor = 'chriskenny.bsky.social',
  others = 'bskyr.bsky.social',
  auth = auth
)
  

#edges <- rel %>%
#  filter(following) %>%
#  transmute(from = actor, to = handle)

# Criar grafo
#g <- graph_from_data_frame(edges, directed = TRUE)

# Plot b√°sico
#plot(g, vertex.label.color = "black", vertex.size = 30, edge.arrow.size = 0.5)

#ggraph(g, layout = "fr") +
#  geom_edge_link(arrow = arrow(length = unit(4, 'mm')), end_cap = circle(3, 'mm')) +
#  geom_node_point(size = 5, color = "steelblue") +
#  geom_node_text(aes(label = name), repel = TRUE) +
#  theme_void()
```




