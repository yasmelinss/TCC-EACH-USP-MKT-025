---
title: "Arquivo de extração de dados - teste 4"
author: "Yasmin Messias Lins"
lang: pt-br
format: html
# format: 
#   pdf:
#     geometry:
#       - top=1in
#       - bottom=1in
#       - left=1in
#       - right=1in
#       - heightrounded
execute: 
  cache: true
---

# SETUP
```{r}
#| label: setup
#| warning: false

#library(bskyr)
library(tidyverse)
#library(readr)
library(jsonlite)
library(atrrr)
#library(ggplot2)
library(igraph)
library(ggraph)
library(tidygraph)
```

# Autenticação

```{r}
#| label: autentica

auth(
  user = 'yasmelinss.bsky.social',
  password = read_lines("senha.txt"),
  overwrite = TRUE
)
```

# Glossário


# Extração

```{r}
#| label: extracao-search-post

querys <- 
  c('cblol','lol')

posts <-
  search_post(
    q = querys,
    limit = 3L,
    since = "2024-08-30",
    until = "2024-09-08"
  ) |>
  select(
    handle = author_handle,
    like_count,
    uri 
  )

view(posts)
```

```{r}
#| label: estracao-get-likes

safe_get_likes <- 
  purrr::possibly(
    get_likes, 
    otherwise = tibble()
    )

likes <- 
  posts$uri |> 
  purrr::map_dfr(
    function(curtida) {
    url <- convert_at_to_http(curtida)
    safe_get_likes(post_url = url) |>
      dplyr::mutate(uri_post = curtida) #está renomeando?
   }
  )


View(likes)

```


```{r}
# GPT Associa cada post ao autor que o publicou
likes_autor <- 
  likes |>
  # junta com o data frame "posts" pra recuperar o autor do post
  dplyr::left_join(
    posts |> dplyr::select(handle, uri),
    by = c("from" = "posts$uri")
  ) |>
  # renomeia para ficar claro
  dplyr::rename(
    from = uri,      # quem escreveu o post
    to = actor_handle          # quem curtiu o post
  ) |>
  # mantém apenas colunas essenciais para o grafo
  dplyr::select(from, to)

View(likes_autor)

```

