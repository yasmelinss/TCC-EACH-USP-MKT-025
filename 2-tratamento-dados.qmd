---
title: "Tratamento dos dados de *likes* em *skeets*"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    embed-resources: true
execute: 
  cache: true
---

```{r}
#| label: setup
#| warning: false

library(tidyverse)
`%!in%` <- negate(`%in%`)
```
## Dados de likes

Montando lista de likes

```{r}
#| label: carrega-likes

likes <-
  list.files(
    path = "Dados/likes", 
    pattern = "*.rds",
    full.names = TRUE
  ) |> 
  map(
    \(nome) {
      read_rds(nome) |> 
        mutate(
          uri.skeet = 
            nome |> 
            str_remove("\\..*$") |> 
            str_replace("^", "at://did:plc:") |> 
            str_replace("-", "/app.bsky.feed.post/"),
          data.skeet = created_at,
          to.actor =
            nome |> 
            str_remove("\\..*$") |> 
            str_replace("Dados/likes/", "did:plc:") |> 
            str_remove("-.*$"),
          from.actor = 
            actor_data |> 
            map_chr(\(x) x$did),
          from.handle =
            actor_data |> 
            map_chr(\(x) x$handle),
          .keep = "none"
        )
    }
  ) |> 
  list_rbind() 

likes |> write_rds("Dados/likes.rds")
```

Criando listas de actors relacionados com likes

```{r}
#| label: criando-liker-actors

# quem curtiu
liker.actors <- 
  likes |> 
  select(from.actor, from.handle) |> 
  unique()
liker.actors |> write_rds("Dados/liker-actors.rds")

# quem foi curtido
liked.actors <- 
  likes$to.actor |> 
  unique()
liked.actors |> write_rds("Dados/liked-actors.rds")

# quem curtiu ou foi curtido
likes.actors <- 
  c(liker.actors$from.actor, liked.actors) |> 
  unique()
likes.actors |> write_rds("Dados/likes-actors.rds")
```

Ou carregando do disco o já processado: só executa se avaliado manualmente

```{r}
#| eval: false

likes <- read_rds("Dados/likes.rds")
liker.actors <- read_rds("Dados/liker-actors.rds")
liked.actors <- read_rds("Dados/liked-actors.rds")
likes.actors <- read_rds("Dados/likes-actors.rds")
```

Montando a matriz de likes dados

```{r}

all.actors <- 
  c(likes$from.actor, likes$to.actor) |> 
  unique() |> 
  sort()

matriz_likes <- 
  likes |> 
  mutate(
    from.actor = 
      from.actor |> 
      factor(levels = all.actors),
    to.actor = 
      to.actor |> 
      factor(levels = all.actors),
  ) |> 
  count(from.actor, to.actor) |>
  pivot_wider(
    names_from = to.actor,
    values_from = n,
    values_fill = 0
  )

matriz_likes
```

Calculando as medidas de centralidade em função dos likes

## Dados de skeets

Carregando a versão curta

```{r}
#| label: carrega-skeets

skeets <- read_rds("Dados/skeets-curto.rds")
```

Separando os skeets com "cblol" em iniciais e replies/quotes

```{r}
skeets.separados <- 
  skeets |> 
  group_by(is.na(uri.reply)) |> # FALSE = reply/quote e TRUE = original
  group_split(.keep = FALSE) |> 
  set_names(c("reply.quote", "original"))
```

